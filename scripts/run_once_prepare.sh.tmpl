#!/bin/bash

set -e

# ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
# ‚îÇ Fun√ß√µes auxiliares                           ‚îÇ
# ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

print_section() {
    echo ""
    echo "‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ"
    echo "‚îÇ $1"
    echo "‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ"
}

# ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
# ‚îÇ In√≠cio                                        ‚îÇ
# ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
echo "üöÄ [+] Iniciando script de prepara√ß√£o..."

if [[ -z "$GITHUB_USERNAME" ]]; then
    GITHUB_USERNAME="EdimarDeSa"
fi

# Atualiza√ß√£o do sistema
print_section "Atualizando sistema"
touch ~/.hushlogin
sudo apt update && sudo apt upgrade -y
echo "‚úÖ Sistema atualizado"

# Instalar Neovim
print_section "Verificando Neovim"
if command_exists nvim; then
    echo "‚úÖ Neovim j√° est√° instalado"
else
    echo "üì¶ Instalando Neovim..."
    sudo apt install -y neovim
    echo "‚úÖ Neovim instalado"
fi

# # Instalar o github cli
# print_section "Verificando GitHub CLI"
# if command_exists gh; then
#     echo "‚úÖ GitHub CLI j√° est√° instalado"
# else
#     echo "üì¶ Instalando GitHub CLI..."
#     sudo apt install -y gh
#     echo "‚úÖ GitHub CLI instalado"
# fi

# Instalar Docker
print_section "Verificando Docker"
if command_exists docker; then
    echo "‚úÖ Docker j√° est√° instalado"
else
    echo "üì¶ Instalando Docker..."
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
        sudo apt remove -y $pkg || true
    done

    sudo apt install -y ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    sudo groupadd docker || true
    sudo usermod -aG docker "$USER"
    echo "‚úÖ Docker instalado"
fi

# Instalar Zsh + Oh My Zsh
print_section "Verificando zsh"
if command_exists zsh; then
    echo "‚úÖ zsh j√° est√° instalado"
else
    echo "üì¶ Instalando zsh..."
    sudo apt install -y zsh
    echo "‚ú® Instalando Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# Instalar Bitwarden CLI
print_section "Verificando Bitwarden CLI"
if command_exists bw; then
    echo "‚úÖ Bitwarden CLI j√° est√° instalado"
else
    echo "üì¶ Instalando Bitwarden CLI..."
    sudo snap install bw
fi

print_section "Configurando git"

# Adiciona cor em todas as sa√≠das do Git
git config --global color.ui auto

# Exibe status com branch, altera√ß√µes e resumo mais visual
git config --global status.showUntrackedFiles all

# Mostra o diff com palavras (√∫til para Markdown e texto)
git config --global diff.compactionHeuristic true
git config --global diff.mnemonicPrefix true
git config --global diff.colorMoved zebra

# Editor padr√£o (mude se quiser usar o VS Code)
git config --global core.editor "code --wait"

# Evita sobrescrever mudan√ßas locais sem querer ao fazer pull
git config --global pull.rebase false

# Garante que voc√™ ver√° conflitos se algu√©m mudou o mesmo trecho
git config --global merge.conflictstyle diff3

# Resumo de log com gr√°fico de branches
git config --global alias.lg "log --oneline --graph --decorate --all"

# Reset seguro do √∫ltimo commit (mant√©m as mudan√ßas)
git config --global alias.undo "reset --soft HEAD~1"

# Adiciona todos os arquivos e faz commit com mensagem
git config --global alias.ac '!git add -A && git commit -m'

# Mostra qual branch remoto est√° sendo trackeado
git config --global branch.autosetupmerge always

mkdir -p ~/.config/git
cat <<EOF > ~/.config/git/commit-template.txt
# Exemplo:
# feat(api): adiciona endpoint de listagem de usu√°rios
# fix(auth): corrige bug de login com token expirado
EOF

git config --global commit.template ~/.config/git/commit-template.txt

# Configura comando ssh
# git config --global core.sshCommand 'ssh -i ~/.ssh/id_ed25519'
echo "Crie ou configure a chave ssh manualmente"

# Cria aliases
git config --global alias.st status
git config --global alias.co checkout
git config --global alias.cm 'commit -m'

# Configura usu√°rio padr√£o para os commits
git config --global user.name "$GITHUB_USERNAME"
if [[ -n "$PRO_EMAIL" ]]; then
    git config --global user.email "$PRO_EMAIL"
else
    echo "‚ö†Ô∏è  E-mail profissional n√£o encontrado. Configure manualmente com:"
    echo "    git config --global user.email 'seu@email.com'"
fi

# Finaliza√ß√£o
print_section "Finalizado!"
echo "üèÅ Script de prepara√ß√£o conclu√≠do com sucesso."
echo "üîÑ Para usar o zsh como shell padr√£o, execute: chsh -s $(which zsh)"
