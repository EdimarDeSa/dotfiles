#! /bin/bash

set -e

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ FunÃ§Ãµes auxiliares                           â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

print_section() {
    echo ""
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo "â”‚ $1"
    echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InÃ­cio                                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
echo "ğŸš€ [+] Iniciando script de preparaÃ§Ã£o..."

if [[ -z "$GITHUB_USERNAME" ]]; then
    GITHUB_USERNAME="EdimarDeSa"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Validar Gerenciador de Pacotes               â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
if ! command_exists apt; then
    echo "âŒ Erro: Gerenciador de pacotes 'apt' nÃ£o encontrado. Este script requer um sistema baseado em Debian/Ubuntu."
    exit 1
fi

if ! sudo -n true 2>/dev/null; then
    echo "ğŸ” Este script requer privilÃ©gios de sudo. Verifique suas permissÃµes."
    if ! sudo -v; then
        echo "âŒ Falha ao validar sudo. Finalizando."
        exit 1
    fi
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ AtualizaÃ§Ã£o do sistema                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Atualizando sistema"
touch "$HOME"/.hushlogin
mkdir -p "$HOME/.pswds"
sudo apt update && sudo apt upgrade -y
sudo apt install bash-completion
echo "âœ… Sistema atualizado"

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Neovim                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Neovim"
if command_exists nvim; then
    echo "âœ… Neovim jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Neovim..."
    sudo apt install -y neovim
    echo "âœ… Neovim instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Docker                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Docker"
if command_exists docker; then
    echo "âœ… Docker jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Docker..."
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
        sudo apt remove -y $pkg || true
    done

    sudo apt install -y ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" |
        sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    sudo groupadd docker || true
    sudo usermod -aG docker "$USER"
    echo "âœ… Docker instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Bitwarden CLI                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Bitwarden CLI"
BW_BIN=/usr/local/bin/bw
if command_exists bw; then
    echo "âœ… Bitwarden CLI jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Bitwarden CLI..."
    sudo mkdir -p /usr/local/bin
    BW_ZIP=$(mktemp)

    curl -fsSL "https://bitwarden.com/download/?app=cli&platform=linux" -o "$BW_ZIP"
    sudo unzip -j "$BW_ZIP" bw -d /usr/local/bin
    sudo chmod +x "$BW_BIN"
    rm "$BW_ZIP"

    # Adicionar ao PATH se necessÃ¡rio
    if [[ ":$PATH:" != *":/usr/local/bin/:"* ]]; then
        echo "export PATH=/usr/local/bin/:$PATH" >>"$HOME/.bashrc"
    fi
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InstalaÃ§Ã£o do jq                             â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Jq"
if command_exists jq; then
    echo "âœ… jq jÃ¡ estÃ¡ instalado"
else
    echo "Instalando jq"
    sudo apt install jq -y
    echo "jq instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InstalaÃ§Ã£o do Git                            â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Git"
if command_exists git; then
    echo "git jÃ¡ estÃ¡ instalado"
else
    echo "Instalando git"
    sudo apt install git -y
    echo "git instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Acesso bitwareden e SSH                      â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Login bitwarden"

# Extrai e configura as chaves SSH
get_ssh_key() {
    local ssh_file_path="$HOME/.ssh/$1"
    local ssh_file_path_pub="$HOME/.ssh/$1.pub"
    if [[ ! -f "$ssh_file_path" ]]; then
        "$BW_BIN" get item "$1" --session "$BW_SESSION" --raw |
            jq -r '.notes' >"$ssh_file_path"

        "$BW_BIN" get item "$1" --session "$BW_SESSION" --raw |
            jq -r '.fields[0].value' >"$ssh_file_path_pub"

        chmod 600 "$ssh_file_path"
        chmod 644 "$ssh_file_path_pub"

        eval "$(ssh-agent -s)" >/dev/null 2>&1
        ssh-add "$ssh_file_path"
    fi
}

if "$BW_BIN" status | grep -q "locked" >/dev/null 2>&1; then
    echo "Bitwarden ja estÃ¡ logado, desbloqueando..."
    BW_CMD="unlock"
else
    echo "Login no Bitwarden..."
    BW_CMD="login"
fi

echo "Desbloqueando Bitwarden..."
if [[ -f "$HOME/.pswds/bw" ]]; then
    BW_SESSION=$("$BW_BIN" $BW_CMD --raw --passwordfile "$HOME/.pswds/bw")
elif [[ -n "$BW_PASSWORD" ]]; then
    BW_SESSION=$("$BW_BIN" $BW_CMD --raw --passwordenv BW_PASSWORD)
else
    BW_SESSION=$("$BW_BIN" $BW_CMD --raw)
fi

# Configura chave SSH
mkdir -p "$HOME"/.ssh
chmod 700 "$HOME"/.ssh

if [[ -n "$BW_SESSION" ]]; then
    export BW_SESSION=$BW_SESSION
    "$BW_BIN" sync

    # Chaves de deploy do github
    echo "Buscando chaves ssh"
    get_ssh_key ssh_github
    get_ssh_key dev_server
    get_ssh_key efscode_github
    get_ssh_key iap_1000
    echo "Chaves recuperadas"

    # Configura usuÃ¡rio padrÃ£o para os commits
    git config --global user.name "$GITHUB_USERNAME"
    git config --global user.email "$("$BW_BIN" get username "ccffb181-84e2-4cd5-8d7a-b08200cb6bdb" --session "$BW_SESSION")"
    git config --global core.sshCommand "ssh -i ~/.ssh/ssh_github -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

else
    echo "âš ï¸  Bitwarden nÃ£o disponÃ­vel. Pulando chaves SSH e e-mail do Git."
fi

# Dnado permissÃ£o de execuÃ§Ã£o ao scripts pessoais
chmod +x "$HOME"/scripts/personal_functions/* 2>/dev/null || true

# FinalizaÃ§Ã£o
print_section "Finalizado!"
echo "ğŸ Script de preparaÃ§Ã£o concluÃ­do com sucesso."
