#! /bin/bash

set -e

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ FunÃ§Ãµes auxiliares                           â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

print_section() {
    echo ""
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo "â”‚ $1"
    echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
}

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InÃ­cio                                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
echo "ğŸš€ [+] Iniciando script de preparaÃ§Ã£o..."

if [[ -z "$GITHUB_USERNAME" ]]; then
    GITHUB_USERNAME="EdimarDeSa"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ AtualizaÃ§Ã£o do sistema                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Atualizando sistema"
touch ~/.hushlogin
sudo apt update && sudo apt upgrade -y
echo "âœ… Sistema atualizado"

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Neovim                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Neovim"
if command_exists nvim; then
    echo "âœ… Neovim jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Neovim..."
    sudo apt install -y neovim
    echo "âœ… Neovim instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Docker                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Docker"
if command_exists docker; then
    echo "âœ… Docker jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Docker..."
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
        sudo apt remove -y $pkg || true
    done

    sudo apt install -y ca-certificates curl
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc

    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    sudo groupadd docker || true
    sudo usermod -aG docker "$USER"
    echo "âœ… Docker instalado"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Instalar Bitwarden CLI                       â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Verificando Bitwarden CLI"
if command_exists bw; then
    echo "âœ… Bitwarden CLI jÃ¡ estÃ¡ instalado"
else
    echo "ğŸ“¦ Instalando Bitwarden CLI..."
    sudo mkdir -p /usr/local/bin
    BW_ZIP=$(mktemp)

    curl -fsSL "https://bitwarden.com/download/?app=cli&platform=linux" -o "$BW_ZIP"
    sudo unzip -j "$BW_ZIP" bw -d /usr/local/bin
    sudo chmod +x /usr/local/bin/bw
    rm "$BW_ZIP"

    # Adicionar ao PATH se necessÃ¡rio
    if [[ ":$PATH:" != *":/usr/local/bin/:"* ]]; then
        echo 'export PATH="/usr/local/bin/:$PATH"' >> ~/.bashrc
    fi
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ InstalaÃ§Ã£o do Git                            â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
start_section "Verificando Git"
if command_exists git; then
    end_section "git jÃ¡ estÃ¡ instalado"
else
    start_install "git"
    sudo apt install git -y
    end_install "git"
fi

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ Acesso bitwareden e SSH                      â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Login bitwarden"
BW_CMD=~/usr/local/bin/bw
"$BW_CMD" logout 2>/dev/null || true

"$BW_CMD" login --apikey
BW_SESSION=$("$BW_CMD" unlock --raw)

# Configura chave SSH
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Extrai e configura as chaves SSH
"$BW_CMD" get item "$SSH_ITEM" --session "$BW_SESSION" --raw | \
    jq -r '.sshKey.privateKey' > ~/.ssh/deploy_key

"$BW_CMD" get item "$SSH_ITEM" --session "$BW_SESSION" --raw | \
    jq -r '.sshKey.publicKey' > ~/.ssh/deploy_key.pub

# Altera o nÃ­vel de permissÃ£o
chmod 600 ~/.ssh/deploy_key
chmod 644 ~/.ssh/deploy_key.pub

# Adicionar ao ssh-agent
eval "$(ssh-agent -s)" >/dev/null
ssh-add ~/.ssh/deploy_key

# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ ConfiguraÃ§Ã£o do git                          â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
print_section "Configurando git"

# Adiciona cor em todas as saÃ­das do Git
git config --global color.ui auto

# Exibe status com branch, alteraÃ§Ãµes e resumo mais visual
git config --global status.showUntrackedFiles all

# Mostra o diff com palavras (Ãºtil para Markdown e texto)
git config --global diff.compactionHeuristic true
git config --global diff.mnemonicPrefix true
git config --global diff.colorMoved zebra

# Editor padrÃ£o (mude se quiser usar o VS Code)
git config --global core.editor "code --wait"

# Evita sobrescrever mudanÃ§as locais sem querer ao fazer pull
git config --global pull.rebase false

# Garante que vocÃª verÃ¡ conflitos se alguÃ©m mudou o mesmo trecho
git config --global merge.conflictstyle diff3

# Resumo de log com grÃ¡fico de branches
git config --global alias.lg "log --oneline --graph --decorate --all"

# Reset seguro do Ãºltimo commit (mantÃ©m as mudanÃ§as)
git config --global alias.undo "reset --soft HEAD~1"

# Adiciona todos os arquivos e faz commit com mensagem
git config --global alias.ac '!git add -A && git commit -m'

# Mostra qual branch remoto estÃ¡ sendo trackeado
git config --global branch.autosetupmerge always

# Cria aliases
git config --global alias.st status
git config --global alias.co checkout
git config --global alias.cm 'commit -m'

# Configura usuÃ¡rio padrÃ£o para os commits
git config --global user.name "$GITHUB_USERNAME"
if [[ -n "$PRO_EMAIL" ]]; then
    git config --global user.email "$PRO_EMAIL"
else
    echo "âš ï¸  E-mail profissional nÃ£o encontrado. Configure manualmente com:"
    echo "    git config --global user.email 'seu@email.com'"
fi

# Dnado permissÃ£o de execuÃ§Ã£o ao scripts pessoais
chmod +x "$HOME"/scripts/personal_functions/*

# FinalizaÃ§Ã£o
print_section "Finalizado!"
echo "ğŸ Script de preparaÃ§Ã£o concluÃ­do com sucesso."
echo "ğŸ”„ Para usar o zsh como shell padrÃ£o, execute: chsh -s $(which zsh)"
